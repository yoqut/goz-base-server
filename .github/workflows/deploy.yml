name: CI/CD Simple Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SERVER_IP: ${{ secrets.SERVER_IP }}
      SSH_KEY: ${{ secrets.SSH_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t event-backend:latest .
          # Test qilish
          docker run --rm event-backend:latest python --version
          docker run --rm event-backend:latest ls -la /app/

      - name: Save Docker image
        run: docker save event-backend:latest | gzip > image.tar.gz

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          source: "image.tar.gz,docker-compose.yml"
          target: "/var/www/event/goz-base-server/"

      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /var/www/event/goz-base-server
            
            echo "=== Cleaning old containers ==="
            docker-compose down || true
            
            echo "=== Loading new image ==="
            docker load < image.tar.gz
            echo "✅ Image loaded"
            
            echo "=== Starting services ==="
            docker-compose up -d
            
            echo "=== Waiting for startup (30 seconds) ==="
            sleep 30
            
            echo "=== Checking containers ==="
            docker ps
            
            echo "=== Checking Django logs ==="
            docker logs django_web --tail 20
            
            echo "=== Health check ==="
            # Bir necha marotaba urinib ko'rish
            MAX_RETRIES=12
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "Health check attempt $((RETRY_COUNT + 1))..."
              
              # Bir nechta endpoint'larni tekshirish
              if curl -f -s http://localhost:8000/health/ > /dev/null 2>&1; then
                echo "✅ Health check passed!"
                break
              fi
              
              if curl -f -s http://localhost:8000/ > /dev/null 2>&1; then
                echo "✅ Root endpoint accessible!"
                break
              fi
              
              if curl -f -s http://localhost:8000/admin/ > /dev/null 2>&1; then
                echo "✅ Admin endpoint accessible (redirect is OK)!"
                break
              fi
              
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "⏳ Waiting 5 seconds... ($RETRY_COUNT/$MAX_RETRIES)"
              sleep 5
            done
            
            
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "❌ Health check failed after $MAX_RETRIES attempts"
              echo "=== Debug information ==="
              docker logs django_web --tail 100
              docker-compose logs --tail 100
              docker-compose down
              exit 1
            fi
            
            echo "✅ Deployment completed successfully!"
            
            # Cleanup
            rm -f image.tar.gz
            docker image prune -f